version: 2.1
parameters:
  version:
    type: string
    default: "0.0.2"
orbs:
  github-release: h-matsuo/github-release@0.1.3
jobs:
  build:
    docker:
      - image: pvmm/msx-forth83:golang
    environment:
      VERSION: << pipeline.parameters.version >>
    working_directory: /root/forth83
    steps:
      - checkout
      - run: make
      - run: cd /root && ./docker-entrypoint.sh openmsx -script /root/forth83/compile.tcl
      - run: mv /root/forth.dsk /root/msx-forth83-v${VERSION}-alpha.dsk
      - run: echo "export PATH=/root/go/bin:$PATH" >> $BASH_ENV
      - github-release/delete:
          tag: v${VERSION}      
      - github-release/create:
          tag: v${VERSION}
          title: Version v${VERSION}
          description: This release is version v${VERSION}.
          file-path: /root/msx-forth83-v${VERSION}-alpha.dsk
